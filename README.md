# Pseudo-anonymization of French legal cases

[![Build Status](https://travis-ci.com/ELS-RD/anonymisation.svg?token=9BHyni1rDpKLxVsHDRNp&branch=master)](https://travis-ci.com/ELS-RD/anonymisation)

The purpose of this projet is to apply `Named Entity Recognition` (`NER`) to extract specific information from legal cases like 
names, addresses, etc.  
These information will be used in a pseudo-anonymization system.  

## Scope

The only French legal cases massively acquired by `ELS` not pseudo-anonymized are those from appeal Courts.  
The database is called **Jurica**.  
The input data are XML files from **Jurica** as generated by `Temis` covering the period 2008-2018.

The project is focused on finding mentions of entities and guessing their types.  
It doesn't manage pseudo-anonymization (replacing entities text by initials), deciding what to hide, etc.  
For pseudo-anonymization, replacing an entity name by its initials (or hashed initials) can be sufficient.  
It doesn't try to link variation of an entity name to the same entity.  

Deployment is not covered by this project.

> In the future, this project will be put in production.  
However, technical constrains (ex.: memory foot print, avoiding costly hardware) are already taken into account. 

## Challenges

Many `SOTA` algorithms are available as open source project.  
Therefore, developing a `NER` algorithm is not in the scope.  

The main focus of this work is to generate a **large high quality training set**.  
Learning on a dataset only made with simple rules may only build a very weak model repeating the rules.  
Therefore, we have tried to include as many tricks as needed to catch / create complex pattern.  
With those, we have been able to produce a robust model, able to find much more entities than the rules which have been used to create the dataset.  

Below is listed of strategies used:


- `Temis`
    - leveraging the extractions performed by `Temis`
- Rules
    - using some easy to describe patterns to catch some entities (with `regex`)
    - find some other entities using dictionaries
- Name extension
    - extending any discovered entity to the neighbor words when it makes sense
        - done carefully otherwise there is a risk of lowering the quality of the training set 
- Find all occurrences of caught entities
    - looking for all occurrences of each entity already found in a document (2 pass process)
    - building dictionaries of frequent names using all documents and look for them in each of them (2 pass process)
- Dataset augmentation
    - Create some variation of the discovered entities and search for them 
        - By removing first or last name, change the case of one or more word in entity, remove key words (M., Mme, la société, ...), etc.
        - transformation are randomly applied (20% of entities are transformed)
        - make the model more robust to error in the text
        - these variations can not be discovered easily with patterns
            - eg. : changing the case is an easy way to workaround the creation of patterns to catch entities written in lower case
- Miscellaneous tricks
    - removing from train set all paragraphs containing 0 entity 
        - no entity paragraphs may be due to too simplistic patterns
    - Apply some priority rules depending of the source of the entity offset for cases where there is a conflict of type
        - some candidate generators are more safe than others 
        - a `_1` is added to the end of the tag label when it is safe and it is removed during the offset normalization step
    - Look for doubtful MWE candidates and declare them as doubtful
        - doubtful MWE candidates are any sequence of words starting with an up case
        - a filter is then applied to keep only those with a first name (based on a dictionary) 
        - no loss is computed on these entities, meaning they don't influence the model during training

> The purpose of ML is **to smooth the rules and the other tricks**, 
making the whole system much more robust to hard to catch entities. 
Data augmentation in particular has proved to be very efficient.  

## Recognized entity types

- Persons:
    - `PERS`: natural person *(include first name unlike `Temis`)*, **source**: `Temis` + name extension + other occurrences
    - `ORGANIZATION`: organization, **source**: `Temis` + rules + extension + other occurrences
    - `PHONE_NUMBER`: phone number, **source**: rules
    - `LICENCE_PLATE`: licence plate numbers, **source**: rules
- Lawyers:
    - `LAWYER`: lawyers, **source**: rules + other occurrences
    - `BAR`: bar where lawyers are registered *(not done by `Temis`)*, **source**: rules + other occurrences
- Courts:
    - `COURT`: names of French courts, **source**: rules + other occurrences
    - `JUDGE_CLERKS`: judges and court clerks, **source**: rules + other occurrences
- Miscellaneous:
    - `ADDRESS`: addresses *(**very** badly done by `Temis`)*, **source**: rules + other occurrences + dictionary
        - there is no way to always guess if the address owner is a `PERS` or an `ORGANIZATION`, therefore this aspect is not managed
    - `DATE`: any date, in numbers or letters, **source**: rules + other occurrences
    - `RG` : ID of the legal case, **source**: `Temis` + rules
    - `UNKNOWN` : only for train set, indicates that no loss should be apply on the word, whatever the prediction is, **source**: rules + dictionary

To each type, dataset augmentation and miscellaneous tricks have been applied.  
`Temis` only managed `PERS`, `ADDRESS` and `RG` types.  

In the future, French legislation may require to pseudo-anonymize following mentions in addition to those already known:

* first name of natural person
* judge name
* clerk name
* lawyer name

> Only taking care of `PERS` and `ADDRESS` entities has been tried at first.  
It appeared that there was some issues with the other entity types.  
Therefore, these entity types have been added, greatly improving the quality of `PERS` recognition.  
`RG`. `BAR` and `DATE` where very easy to add and are useful for some specific purposes.  

Type of entities that will not be included:

- social security numbers: there are too few, not enough to learn anything and it makes the associated risk very low (3 numbers for 30 000 cases checked)
- credit card number: not found in 30 000 cases, very low risk.

All the types to add may be managed by `regex`.

## Model

Main NER model is from [Spacy](https://spacy.io/) library and is best described in this [video](https://www.youtube.com/watch?v=sqDHBH9IjRU).
  
Basically it is a **CNN + HashingTrick / Bloom filter + L2S** approach over it.  
The L2S part is very similar to classical dependency parser algorithm (stack + actions).

### Advantages of the `Spacy` approach:

- *no manual feature extraction* (done by `Spacy`: suffix and prefix, 3 letters each, and the word shape)
- quite *rapid on `multicore CPU`* (to limit anonymization cost)
- *low memory foot print* (for possible [Lambda deployment](https://github.com/ryfeus/lambda-packs), to limit cost)
- off the shelf algorithm (documented, maintained, large community, third party lib, etc.)

Project is fully written in `Python` and can't be rewritten in something else because `Spacy` only exists on `Python`.  

> `Spark` on `Scala` in particular would be a bad choice for this project (`NLP` tools are limited).

Other approaches (`Bi-LSTM`, etc.) may have shown slightly better performances but are much slower to train and during inference.  
For these reasons, and the specific need to run it over a `GPU` (costly option), they are not in our scope.  
If available, `Spacy` can leverage `GPU`, however this option has not been explored.  

## Resources

No language related resource are used.

Few open data dictionary are used:

- a dictionary of French first names ([open data](https://opendata.paris.fr/explore/dataset/liste_des_prenoms_2004_a_2012/?disjunctive.annee&disjunctive.prenoms))
- a dictionary of postal code and cities of France ([open data](https://www.data.gouv.fr/fr/datasets/base-officielle-des-codes-postaux/))

> Both resources are stored on the Git repository (`resources/` folder).  
Both are not strategic to the success of the learning but provide a little help.

## Data and model paths

Paths listed below can be modified in the config file `resources/config.ini`.

### `XML`
- Cases have to be provided as XML in the format used by `Temis`.  
- One XML file represents one week of legal cases.  
- `XML` files should be put in folder `resources/training_data/`.  
- The case used for inference has to be placed in `resources/dev_data/`.  
- Folder `resources/test/` contains a `XML` used for unit tests.

### Other resources  
- Resources are to be put in folder `resources/courts`, `resources/postal_codes`, `resources/first_names`.  

### Model   
- Folder `resources/model/` will contain the `Spacy` model.


## Commands to use the code

This project uses [Python virtual environment](https://virtualenv.pypa.io/en/stable/) to manage dependencies without interfering with the those used by the machine.  
`pip3` and `python3` are the only requirements.  
To setup a virtual environment on the machine, install `virtualenv` from `pip3` and install the project dependencies (from the `requirements.txt` file).  

These steps are scripted in the `Makefile` (tested only on `Ubuntu`) and can be performed with the following command:  

```bash
make setup
```

> Variable `VIRT_ENV_FOLDER` can be changed in the `Makefile` to change where to install `Python` dependencies.

... then you can use the project by running one of the following actions:

* train a model

```bash
make train
```

* Find and export frequent entities (these entities are caught in all documents during the training set creation)

```bash
make export_frequent_entities
```

* view `Spacy` results on a local web page ([`http://localhost:5000`](http://localhost:5000))

```bash
make show_spacy_entities
```

* view `Temis` results on a local web page ([`http://localhost:5000`](http://localhost:5000))

```bash
make show_temis_entities
```

* view differences between Spacy and `Temis` (only for shared entity types)

```bash
make list_differences
```

* run unit tests

```bash
make test
```

> Most of the project configuration is done in `resources/config.ini` file.

### TODO:

- change name LAWYER -> LEGAL_OFFICER
- switch to flashtext (to improve performances during training set preparation) https://github.com/vi3k6i5/flashtext
- create test set
- vote en cas de doute sur le type d'une entité et si doute regarder le type de l'occurence (pendant training)
- test if dubious entity match another one (A in B), even after splitting in words -> pour lever un doute
- test merging of type entities with the one guessed when there is a doubt
- Court formation
- test indicating that an entity has been found only one time with NER and many times with match
- implement prediction with multi thread (pipe) V2.1 ? https://github.com/explosion/spaCy/issues/1530 
- Add rapporteurs / experts (close to word rapport) ?
- paste randomly the first word of a NER with the previous word to simulate recurrent typo errors

Number of tags: 1773909
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
  0%|          | 0/145040.8 [00:00<?, ?it/s]
Iter 1
 10%|▉         | 14504/145040.8 [2:09:49<18:59:21,  1.91it/s]{'ner': 57.427544362485946}

Iter 2
 20%|██        | 29009/145040.8 [4:18:30<17:04:46,  1.89it/s]{'ner': 36.54777899100043}

Iter 3
 30%|███       | 43515/145040.8 [6:27:13<11:37:35,  2.43it/s]{'ner': 32.62351346588014}

Iter 4
 40%|████      | 58019/145040.8 [8:39:24<15:51:11,  1.52it/s]{'ner': 30.822936655417266}

Iter 5
 50%|█████     | 72525/145040.8 [10:52:50<9:14:25,  2.18it/s] {'ner': 29.70916408157069}

Iter 6
 60%|██████    | 87029/145040.8 [13:06:14<8:45:25,  1.84it/s]{'ner': 28.97088341355564}

Iter 7
 70%|███████   | 101534/145040.8 [15:19:42<6:31:44,  1.85it/s]{'ner': 28.445833063707028}

Iter 8
 80%|████████  | 116039/145040.8 [17:33:06<4:28:08,  1.80it/s]{'ner': 27.971498231318378}

Iter 9
 90%|█████████ | 130544/145040.8 [19:46:28<2:23:44,  1.68it/s]{'ner': 27.52150698761693}

--------------
Number of tags: 1775635
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))

Iter 1
 50%|█████     | 14382/28763.26 [2:04:41<1:49:30,  2.19it/s]{'ner': 59.536253356406405}

Iter 2
100%|█████████▉| 28763/28763.26 [4:10:13<00:00,  1.89it/s]{'ner': 39.26536671542931}
28764it [4:10:13,  2.14it/s]        
-------------------
Number of tags: 1789948
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))

Iter 1
 25%|██▍       | 14454/57816.04 [2:06:59<6:06:57,  1.97it/s]{'ner': 67.71795046884715}

Iter 2
 50%|█████     | 28909/57816.04 [4:13:19<4:05:11,  1.96it/s]{'ner': 46.69826582446979}

Iter 3
 75%|███████▌  | 43365/57816.04 [6:19:56<1:36:55,  2.49it/s]{'ner': 42.69678843677113}

Iter 4
57819it [8:29:44,  1.85it/s]{'ner': 40.70850695853477}
57820it [8:29:44,  2.42it/s]
----------------------
Number of tags: 1828754
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
  0%|          | 0/58912.84 [00:00<?, ?it/s]
Iter 1
 25%|██▍       | 14728/58912.84 [2:09:00<6:18:45,  1.94it/s]{'ner': 67.85554110441444}

Iter 2
 50%|█████     | 29458/58912.84 [4:21:36<3:27:16,  2.37it/s]{'ner': 46.97043271907819}

Iter 3
 75%|███████▌  | 44187/58912.84 [6:34:35<1:50:43,  2.22it/s]{'ner': 43.03420076370094}

Iter 4
58916it [8:51:00,  2.00it/s]
{'ner': 41.01037724554021}
-------
Number of tags: 1838488
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
  0%|          | 0/147282.1 [00:00<?, ?it/s]
Iter 1
 10%|▉         | 14728/147282.1 [2:08:14<18:56:38,  1.94it/s]{'ner': 66.24498462381916}

Iter 2
 20%|██        | 29458/147282.1 [4:17:05<14:30:56,  2.25it/s]{'ner': 45.65171872189785}

Iter 3
 30%|███       | 44187/147282.1 [6:26:10<12:32:49,  2.28it/s]{'ner': 41.7875151321731}

Iter 4
 40%|████      | 58915/147282.1 [8:38:55<13:11:23,  1.86it/s]{'ner': 39.87230896325718}

Iter 5
 50%|█████     | 73645/147282.1 [10:52:38<8:17:44,  2.47it/s] {'ner': 38.66143961688948}

Iter 6
 60%|██████    | 88373/147282.1 [13:06:16<8:45:27,  1.87it/s]{'ner': 37.84853459032075}

Iter 7
 70%|███████   | 103103/147282.1 [15:20:09<4:59:31,  2.46it/s]{'ner': 37.12548023300906}

Iter 8
 80%|████████  | 117832/147282.1 [17:33:47<3:32:43,  2.31it/s]{'ner': 36.63719058544939}

Iter 9
 90%|█████████ | 132560/147282.1 [19:47:40<2:16:39,  1.80it/s]{'ner': 36.07416604219725}

Iter 10
147289it [22:01:32,  1.91it/s]{'ner': 35.80839124857698}
147290it [22:01:32,  2.25it/s]
---------
Number of tags: 1838747
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
  0%|          | 0/58912.84 [00:00<?, ?it/s]
Iter 1
 25%|██▌       | 14729/58912.84 [2:07:57<5:11:57,  2.36it/s]{'ner': 67.09906184357169}

Iter 2
 50%|█████     | 29457/58912.84 [4:16:38<4:24:54,  1.85it/s]{'ner': 46.027869963762896}

Iter 3
 75%|███████▌  | 44187/58912.84 [6:25:35<1:47:29,  2.28it/s]{'ner': 42.25843731397822}

Iter 4
58915it [8:38:10,  1.88it/s]{'ner': 40.20154718467688}
58916it [8:38:10,  2.29it/s]
---------
Number of tags: 1855688
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))

Iter 1
 33%|███▎      | 14750/44247.48 [2:10:24<3:34:44,  2.29it/s]{'ner': 71.92923828106768}

Iter 2
 67%|██████▋   | 29499/44247.48 [4:29:25<2:21:42,  1.73it/s]{'ner': 50.688311473414615}

Iter 3
44249it [7:00:41,  1.66it/s]{'ner': 46.80857206960354}
44250it [7:00:41,  2.13it/s]
---------
Number of tags: 2660741
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))

Iter 1
 25%|██▌       | 17340/69358.24 [2:34:08<6:58:10,  2.07it/s]{'ner': 77.59002592418801}

Iter 2
 50%|█████     | 34680/69358.24 [5:07:29<4:10:34,  2.31it/s]{'ner': 52.346716683900695}

Iter 3
 75%|███████▌  | 52020/69358.24 [7:42:34<2:40:01,  1.81it/s]{'ner': 48.173801577489485}

Iter 4
69360it [10:21:42,  2.04it/s]
-------------
Number of tags: 2768352
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))

  0%|          | 0/69481.48 [00:00<?, ?it/s]Iter 1
 25%|██▍       | 17370/69481.48 [2:44:06<7:58:20,  1.82it/s]{'ner': 77.94199584166518}

Iter 2
 50%|█████     | 34742/69481.48 [5:23:34<4:37:07,  2.09it/s]{'ner': 52.069788763078805}

Iter 3
 75%|███████▌  | 52113/69481.48 [8:04:13<2:08:17,  2.26it/s]{'ner': 47.722335816293025}

Iter 4
69483it [10:48:56,  1.78it/s]{'ner': 45.65050949805317}
69484it [10:48:56,  2.11it/s]
---------------
Learn NER model: 100%|██████████| 28635/28635 [41:59<00:00,  7.34 paragraphs/s]
Number of tags: 2849201
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))

Iter 1
Learn NER model:  25%|██▍       | 17402/69612.0 [2:33:45<8:00:32,  1.81 paragraphs/s, loss: 79.66364140904534]
Iter 2
Learn NER model:  50%|█████     | 34806/69612.0 [5:10:56<5:33:31,  1.74 paragraphs/s, loss: 53.21245321840115] 
Iter 3
Learn NER model:  75%|███████▌  | 52209/69612.0 [7:49:55<2:35:10,  1.87 paragraphs/s, loss: 48.89310116812737] 
Iter 4
Learn NER model: 100%|██████████| 69612/69612.0 [10:32:52<00:00,  1.74 paragraphs/s, loss: 46.81073942351145]
---------------
Generate NER dataset: 100%|██████████| 28635/28635 [43:19<00:00,  6.58 paragraphs/s]
Number of tags: 2844758
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
Learn NER model:   0%|          | 0/69565.08 [00:00<?, ? paragraphs/s]
Iter 1
Learn NER model:  25%|██▌       | 17392/69565.08 [2:38:34<6:26:07,  2.25 paragraphs/s, loss: 78.71839616297939]
Iter 2
Learn NER model:  50%|█████     | 34783/69565.08 [5:17:17<5:45:50,  1.68 paragraphs/s, loss: 53.019130392607394]
Iter 3
Learn NER model:  75%|███████▌  | 52175/69565.08 [7:58:11<2:57:37,  1.63 paragraphs/s, loss: 48.63673049783756]
Iter 4
Learn NER model: 69568 paragraphs [10:43:07,  2.11 paragraphs/s, loss: 46.45809067338905] 
----------------
Generate NER dataset: 100%|██████████| 28635/28635 [43:32<00:00,  7.10 paragraphs/s]
Number of tags: 2845332
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
Learn NER model:   0%|          | 0/69572.76 [00:00<?, ? paragraphs/s]
Iter 1
Learn NER model:  25%|██▍       | 17393/69572.76 [2:39:13<8:14:59,  1.76 paragraphs/s, loss: 78.96393741577049]
Iter 2
Learn NER model:  50%|█████     | 34788/69572.76 [5:20:27<4:21:54,  2.21 paragraphs/s, loss: 53.76299955105512]
Iter 3
Learn NER model:  75%|███████▌  | 52181/69572.76 [8:03:34<2:40:13,  1.81 paragraphs/s, loss: 49.494463511491176]
Iter 4
Learn NER model: 69576 paragraphs [10:53:42,  2.22 paragraphs/s, loss: 47.33417880529146]
---------------
Learn NER model: 69652 paragraphs [10:31:30,  1.76 paragraphs/s, loss: 46.25509752095968]
---------------
Generate NER dataset: 100%|██████████| 28635/28635 [44:59<00:00,  6.55 paragraphs/s]
Learn NER model: 69988 paragraphs [11:06:39,  2.09 paragraphs/s, loss: 43.44088593197807]
Train model
Number of tags: 2918705
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
----------------
Train model
Generate NER dataset: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 28635/28635 [48:36<00:00,  6.06 paragraphs/s]
Number of tags: 2919361
Warning: Unnamed vectors -- this won't allow multiple vectors models to be loaded. (Shape: (0, 0))
Learn NER model:   0%|                                                                                                                                                | 0/174998.0 [00:00<?, ? paragraphs/s]
Iter 1
Learn NER model:  10%|██████████▏                                                                                           | 17500/174998.0 [2:41:32<21:16:45,  2.06 paragraphs/s, loss: 75.34138347498856]
Iter 2
Learn NER model:  20%|████████████████████▍                                                                                 | 35000/174998.0 [5:19:49<19:40:48,  1.98 paragraphs/s, loss: 49.65280865320585]
Iter 3
Learn NER model:  30%|██████████████████████████████▎                                                                      | 52500/174998.0 [8:00:26<17:59:12,  1.89 paragraphs/s, loss: 45.363332665160726]
Iter 4
Learn NER model:  40%|████████████████████████████████████████▍                                                            | 70000/174998.0 [10:44:53<15:57:23,  1.83 paragraphs/s, loss: 43.16471506145115]
Iter 5
Learn NER model:  50%|██████████████████████████████████████████████████▌                                                  | 87500/174998.0 [13:29:25<13:27:09,  1.81 paragraphs/s, loss: 41.85824288280435]
Iter 6
Learn NER model:  60%|████████████████████████████████████████████████████████████                                        | 105000/174998.0 [16:13:59<10:11:17,  1.91 paragraphs/s, loss: 40.87253470580873]
Iter 7
Learn NER model:  70%|███████████████████████████████████████████████████████████████████████▍                              | 122500/174998.0 [18:58:29<7:32:52,  1.93 paragraphs/s, loss: 40.2090535125991]
Iter 8
Learn NER model:  80%|████████████████████████████████████████████████████████████████████████████████▊                    | 140000/174998.0 [21:43:02<4:44:40,  2.05 paragraphs/s, loss: 39.67898587027514]
Iter 9
Learn NER model:  90%|███████████████████████████████████████████████████████████████████████████████████████████▊          | 157500/174998.0 [24:27:37<2:48:19,  1.73 paragraphs/s, loss: 39.3203777237822]
Iter 10
Learn NER model: 175000 paragraphs [27:12:12,  1.98 paragraphs/s, loss: 38.7637807685702] 
-----------------
Ajouter un pattern d addresse:
BP 40122
